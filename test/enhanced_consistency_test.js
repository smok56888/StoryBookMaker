// æµ‹è¯•å¢å¼ºçš„ä¸€è‡´æ€§ç³»ç»Ÿ
// æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºæµ‹è¯•æ–‡ä»¶ï¼Œå±•ç¤ºæ–°çš„ä¸€è‡´æ€§ä¿éšœæœºåˆ¶

async function testEnhancedConsistency() {
  console.log('ğŸ¯ å¼€å§‹æµ‹è¯•å¢å¼ºçš„ä¸€è‡´æ€§ç³»ç»Ÿ...\n');
  
  // æµ‹è¯•æ•°æ®
  const testParams = {
    storyId: 'enhanced_consistency_001',
    characters: [
      {
        name: 'å°æ˜',
        analysis: '5å²ç”·å­©ï¼Œåœ†è„¸ï¼Œé»‘è‰²çŸ­å‘ï¼Œå¤§çœ¼ç›ï¼Œç©¿çº¢è‰²Tæ¤å’Œè“è‰²çŸ­è£¤ï¼Œæ´»æ³¼å¼€æœ—ï¼Œå–œæ¬¢ç¬‘'
      },
      {
        name: 'å°èŠ±',
        analysis: '4å²å¥³å­©ï¼Œé•¿å‘æ‰é©¬å°¾ï¼Œç©¿ç²‰è‰²è¿è¡£è£™ï¼Œç™½è‰²å°é‹ï¼Œæ–‡é™å¯çˆ±ï¼Œçœ¼ç›å¼¯å¼¯åƒæœˆç‰™'
      }
    ],
    paragraphs: [
      "å°æ˜å’Œå°èŠ±åœ¨å…¬å›­é‡Œç©è€ï¼Œä»–ä»¬å‘ç°äº†ä¸€åªè¿·è·¯çš„å°çŒ«ã€‚",
      "å°æ˜è½»è½»åœ°æŠ±èµ·å°çŒ«ï¼Œå°èŠ±æ‹¿å‡ºè‡ªå·±çš„å°é¥¼å¹²å–‚ç»™å®ƒåƒã€‚",
      "ä»–ä»¬å†³å®šå¸®åŠ©å°çŒ«æ‰¾åˆ°å›å®¶çš„è·¯ï¼Œä¸€èµ·åœ¨å…¬å›­é‡Œå¯»æ‰¾ã€‚",
      "ç»ˆäºåœ¨å¤§æ ‘ä¸‹æ‰¾åˆ°äº†å°çŒ«çš„å¦ˆå¦ˆï¼Œå°çŒ«é«˜å…´åœ°è·‘äº†è¿‡å»ã€‚",
      "å°æ˜å’Œå°èŠ±çœ‹ç€å°çŒ«ä¸€å®¶å›¢èšï¼Œå¼€å¿ƒåœ°ç¬‘äº†ã€‚"
    ],
    title: 'å°æ˜å’Œå°èŠ±çš„å–„è‰¯ä¹‹å¿ƒ'
  };

  console.log('ğŸ“‹ æµ‹è¯•å‚æ•°:');
  console.log('- æ•…äº‹ID:', testParams.storyId);
  console.log('- è§’è‰²æ•°é‡:', testParams.characters.length);
  console.log('- æ®µè½æ•°é‡:', testParams.paragraphs.length);
  console.log('- æ•…äº‹æ ‡é¢˜:', testParams.title);
  console.log('');

  // ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•åŸºç¡€ä¸€è‡´æ€§å…ƒç´ ç”Ÿæˆ
  console.log('ğŸ”§ æ­¥éª¤1: æµ‹è¯•åŸºç¡€ä¸€è‡´æ€§å…ƒç´ ç”Ÿæˆ...');
  const basicElements = generateMockBasicConsistencyElements(testParams.characters);
  console.log('âœ… åŸºç¡€ä¸€è‡´æ€§å…ƒç´ ç”ŸæˆæˆåŠŸ');
  console.log('ğŸ“„ ç”Ÿæˆå†…å®¹:');
  console.log(basicElements);
  console.log('');

  // ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æ ¸å¿ƒå½¢è±¡å…ƒç´ æå–ï¼ˆæ¨¡æ‹Ÿï¼‰
  console.log('ğŸ¨ æ­¥éª¤2: æµ‹è¯•æ ¸å¿ƒå½¢è±¡å…ƒç´ æå–...');
  const mockCoreElements = generateMockCoreElements(testParams);
  console.log('âœ… æ ¸å¿ƒå½¢è±¡å…ƒç´ æå–æˆåŠŸ');
  console.log('ğŸ“„ æå–å†…å®¹ï¼ˆå‰300å­—ç¬¦ï¼‰:');
  console.log(mockCoreElements.substring(0, 300) + '...');
  console.log('');

  // ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•ä¸€è‡´æ€§å¢å¼ºçš„æç¤ºè¯ç”Ÿæˆ
  console.log('ğŸ“ æ­¥éª¤3: æµ‹è¯•ä¸€è‡´æ€§å¢å¼ºçš„æç¤ºè¯ç”Ÿæˆ...');
  const consistentPrompt = generateMockConsistentImagePrompt({
    ...testParams,
    coreElements: mockCoreElements
  });
  console.log('âœ… ä¸€è‡´æ€§å¢å¼ºæç¤ºè¯ç”ŸæˆæˆåŠŸ');
  console.log('ğŸ“Š æç¤ºè¯ç»Ÿè®¡:');
  console.log('- æ€»é•¿åº¦:', consistentPrompt.length, 'å­—ç¬¦');
  console.log('- åŒ…å«æ ¸å¿ƒå…ƒç´ :', consistentPrompt.includes('æ ¸å¿ƒä¸€è‡´æ€§è¦æ±‚'));
  console.log('- åŒ…å«è§’è‰²ç‰¹å¾:', testParams.characters.every(c => consistentPrompt.includes(c.name)));
  console.log('');

  // ç¬¬å››æ­¥ï¼šæµ‹è¯•å“åº”è§£æå’Œä¸€è‡´æ€§å¢å¼º
  console.log('ğŸ” æ­¥éª¤4: æµ‹è¯•å“åº”è§£æå’Œä¸€è‡´æ€§å¢å¼º...');
  const mockResponse = generateMockResponse();
  const parsedResult = parseMockConsistentResponse(mockResponse, testParams.paragraphs.length, mockCoreElements);
  
  console.log('âœ… å“åº”è§£æå®Œæˆ');
  console.log('ğŸ“Š è§£æç»“æœç»Ÿè®¡:');
  console.log('- å°é¢æè¿°é•¿åº¦:', parsedResult.cover.length, 'å­—ç¬¦');
  console.log('- å†…é¡µæ•°é‡:', parsedResult.pages.length);
  console.log('- ç»“å°¾æè¿°é•¿åº¦:', parsedResult.ending.length, 'å­—ç¬¦');
  console.log('- å¹³å‡æè¿°é•¿åº¦:', Math.round(parsedResult.pages.reduce((sum, p) => sum + p.length, 0) / parsedResult.pages.length), 'å­—ç¬¦');
  console.log('');

  // ç¬¬äº”æ­¥ï¼šæµ‹è¯•ä¸€è‡´æ€§æ£€æŸ¥
  console.log('ğŸ¯ æ­¥éª¤5: æµ‹è¯•ä¸€è‡´æ€§æ£€æŸ¥...');
  const consistencyCheck = checkMockConsistency(parsedResult, testParams.characters);
  
  console.log('âœ… ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ');
  console.log('ğŸ“ˆ ä¸€è‡´æ€§è¯„ä¼°:');
  console.log('- è§’è‰²åç§°è¦†ç›–ç‡:', consistencyCheck.characterCoverage + '%');
  console.log('- ç‰¹å¾æè¿°å®Œæ•´æ€§:', consistencyCheck.featureCompleteness + '%');
  console.log('- é£æ ¼ç»Ÿä¸€æ€§:', consistencyCheck.styleConsistency + '%');
  console.log('- æ•´ä½“ä¸€è‡´æ€§è¯„åˆ†:', consistencyCheck.overallScore + '/100');
  console.log('');

  // ç¬¬å…­æ­¥ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åæ•ˆæœ
  console.log('ğŸ“Š æ­¥éª¤6: å¯¹æ¯”ä¼˜åŒ–å‰åæ•ˆæœ...');
  console.log('ä¼˜åŒ–å‰é—®é¢˜:');
  console.log('- âŒ è§’è‰²å¤–è§‚åœ¨ä¸åŒé¡µé¢å·®å¼‚è¾ƒå¤§');
  console.log('- âŒ æœè£…é¢œè‰²å’Œæ¬¾å¼ä¸ç»Ÿä¸€');
  console.log('- âŒ é¢éƒ¨ç‰¹å¾å’Œè¡¨æƒ…å˜åŒ–è¿‡å¤§');
  console.log('- âŒ æ•´ä½“é£æ ¼ç¼ºä¹è¿è´¯æ€§');
  console.log('');
  
  console.log('ä¼˜åŒ–åæ”¹è¿›:');
  console.log('- âœ… æå–æ ¸å¿ƒå½¢è±¡å…ƒç´ ï¼Œå»ºç«‹ä¸€è‡´æ€§æ ‡å‡†');
  console.log('- âœ… æ¯ä¸ªæè¿°éƒ½åŒ…å«è§’è‰²å…³é”®ç‰¹å¾');
  console.log('- âœ… ç»Ÿä¸€çš„ç»˜ç”»é£æ ¼å’Œè‰²å½©æ–¹æ¡ˆ');
  console.log('- âœ… æ™ºèƒ½çš„ä¸€è‡´æ€§å¢å¼ºæœºåˆ¶');
  console.log('');

  // ä½¿ç”¨å»ºè®®
  console.log('ğŸ’¡ ä½¿ç”¨å»ºè®®:');
  console.log('1. ğŸ¯ é»˜è®¤æ¨¡å¼: ä½¿ç”¨ä¸€è‡´æ€§å¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿äººç‰©å½¢è±¡ç»Ÿä¸€');
  console.log('2. âš¡ å¿«é€Ÿæ¨¡å¼: ä»…åœ¨å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜æ—¶ä½¿ç”¨');
  console.log('3. âœï¸  æ‰‹åŠ¨ç¼–è¾‘: æç¤ºè¯ç°åœ¨æ”¯æŒéšæ—¶ç¼–è¾‘ï¼Œå¯è¿›ä¸€æ­¥è°ƒæ•´');
  console.log('4. ğŸ” è´¨é‡æ£€æŸ¥: ç”Ÿæˆåæ£€æŸ¥è§’è‰²ç‰¹å¾æ˜¯å¦ä¿æŒä¸€è‡´');
  console.log('');

  console.log('âœ¨ å¢å¼ºä¸€è‡´æ€§ç³»ç»Ÿæµ‹è¯•å®Œæˆ');
  console.log('ğŸ‰ ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç”Ÿæˆé«˜åº¦ä¸€è‡´çš„ç»˜æœ¬æ’å›¾ï¼');
}

// æ¨¡æ‹ŸåŸºç¡€ä¸€è‡´æ€§å…ƒç´ ç”Ÿæˆ
function generateMockBasicConsistencyElements(characters) {
  const characterElements = characters.map(char => {
    const features = char.analysis.split('ï¼Œ')
    return `${char.name}ï¼š${features.slice(0, 4).join('ï¼Œ')}ï¼ˆæ¯é¡µå¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´ï¼‰`
  }).join('\n')

  return `ã€æ ¸å¿ƒä¸€è‡´æ€§è¦æ±‚ã€‘
${characterElements}

ã€ç»˜ç”»é£æ ¼ç»Ÿä¸€ã€‘
- æ¸©é¦¨çš„å„¿ç«¥ç»˜æœ¬é£æ ¼
- æŸ”å’Œçš„æ°´å½©è´¨æ„Ÿ
- æš–è‰²è°ƒä¸ºä¸»ï¼Œè¥é€ æ¸©é¦¨æ°›å›´
- åœ†æ¶¦å®‰å…¨çš„é€ å‹è®¾è®¡`
}

// æ¨¡æ‹Ÿæ ¸å¿ƒå½¢è±¡å…ƒç´ ç”Ÿæˆ
function generateMockCoreElements(params) {
  return `===== äººç‰©ä¸€è‡´æ€§æ¡£æ¡ˆ =====
å°æ˜
- å¤´éƒ¨ï¼šå‘å‹[é»‘è‰²çŸ­å‘ï¼Œç•¥å¾®è“¬æ¾ï¼Œè‡ªç„¶åˆ†ç¼]ï¼Œå‘è‰²[è‡ªç„¶é»‘è‰²]ï¼Œçœ¼ç›[å¤§è€Œæ˜äº®çš„é»‘è‰²çœ¼ç›ï¼Œçœ¼å½¢åœ†æ¶¦]ï¼Œè„¸å‹[åœ†æ¶¦å¨ƒå¨ƒè„¸ï¼Œè‚‰å˜Ÿå˜Ÿçš„è„¸é¢Š]ï¼Œè‚¤è‰²[å¥åº·å°éº¦è‰²]
- æœè£…ï¼šä¸Šè¡£[é²œçº¢è‰²åœ†é¢†Tæ¤ï¼Œèƒ¸å‰æ— å›¾æ¡ˆ]ï¼Œä¸‹è£…[æ·±è“è‰²ä¼‘é—²çŸ­è£¤ï¼Œé•¿åº¦åˆ°è†ç›–]ï¼Œé‹å­[ç™½è‰²è¿åŠ¨é‹ï¼Œç®€æ´æ¬¾å¼]ï¼Œé…é¥°[æ— ]
- è¡¨æƒ…ï¼šåŸºæœ¬è¡¨æƒ…[æ´»æ³¼å¼€æœ—]ï¼Œç¬‘å®¹[ç¿çƒ‚å¤©çœŸï¼Œéœ²å‡ºå°ç™½ç‰™]ï¼Œçœ‰æ¯›[è‡ªç„¶å¼¯æ›²ï¼Œæµ“å¯†]
- ä½“æ€ï¼šèº«é«˜[æ ‡å‡†5å²æ¯”ä¾‹]ï¼Œä½“å‹[å¥åº·åŒ€ç§°ï¼Œç•¥æ˜¾æ´»æ³¼]ï¼Œå§¿æ€[æŒºæ‹”å¥½åŠ¨]

å°èŠ±
- å¤´éƒ¨ï¼šå‘å‹[é•¿å‘æ‰é©¬å°¾ï¼Œé½åˆ˜æµ·]ï¼Œå‘è‰²[è‡ªç„¶é»‘è‰²ï¼Œæœ‰å…‰æ³½]ï¼Œçœ¼ç›[å¼¯å¼¯å¦‚æœˆç‰™ï¼Œæ¸©æŸ”]ï¼Œè„¸å‹[åœ†æ¶¦å¯çˆ±ï¼Œå°å·§]ï¼Œè‚¤è‰²[ç™½çš™é€äº®]
- æœè£…ï¼šä¸Šè¡£[ç²‰è‰²è¿è¡£è£™ï¼Œç®€çº¦æ¬¾å¼]ï¼Œä¸‹è£…[è¿è¡£è£™ï¼Œé•¿åº¦åˆ°å°è…¿]ï¼Œé‹å­[ç™½è‰²å°çš®é‹ï¼Œåœ†å¤´æ¬¾]ï¼Œé…é¥°[æ— ]
- è¡¨æƒ…ï¼šåŸºæœ¬è¡¨æƒ…[æ–‡é™å¯çˆ±]ï¼Œç¬‘å®¹[æ¸©æŸ”ç”œç¾ï¼Œå˜´è§’å¾®ç¿˜]ï¼Œçœ‰æ¯›[ç»†è‡´å¼¯æ›²]
- ä½“æ€ï¼šèº«é«˜[æ ‡å‡†4å²æ¯”ä¾‹]ï¼Œä½“å‹[å¨‡å°å¯çˆ±]ï¼Œå§¿æ€[æ–‡é™ä¼˜é›…]

===== è‰²å½©æ–¹æ¡ˆ =====
- ä¸»è‰²è°ƒï¼šçº¢è‰²ã€è“è‰²ã€ç²‰è‰²
- è¾…åŠ©è‰²ï¼šç™½è‰²ã€ç»¿è‰²ã€é»„è‰²
- æƒ…æ„ŸåŸºè°ƒï¼šæ¸©æš–æ´»æ³¼
- é¥±å’Œåº¦ï¼šä¸­ç­‰åé«˜

===== ç»˜ç”»é£æ ¼ =====
- çº¿æ¡ï¼šæŸ”å’Œåœ†æ¶¦ï¼Œæ— å°–é”è¾¹è§’
- ç€è‰²ï¼šæ°´å½©é£æ ¼ï¼Œè‡ªç„¶æ¸å˜
- é˜´å½±ï¼šæ·¡è‰²é€æ˜ï¼Œè¥é€ ç«‹ä½“æ„Ÿ
- æ•´ä½“è´¨æ„Ÿï¼šæ¸©é¦¨æ‰‹ç»˜ï¼Œç«¥çœŸå¯çˆ±`
}

// æ¨¡æ‹Ÿä¸€è‡´æ€§å¢å¼ºçš„æç¤ºè¯ç”Ÿæˆ
function generateMockConsistentImagePrompt(params) {
  return `ä½ æ˜¯ä¸“ä¸šçš„å„¿ç«¥ç»˜æœ¬æ’ç”»å¸ˆï¼Œè¯·ä¸ºã€Š${params.title}ã€‹ç”Ÿæˆé«˜åº¦ä¸€è‡´çš„æ’å›¾æè¿°ã€‚

${params.coreElements}

ã€æ•…äº‹å†…å®¹ã€‘
${params.paragraphs.map((p, i) => `ç¬¬${i + 1}é¡µï¼š${p}`).join('\n')}

ã€ä¸€è‡´æ€§è¦æ±‚ã€‘
1. è§’è‰²å¤–è§‚ï¼šä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¸å¿ƒè¦æ±‚ï¼Œæ¯ä¸ªè§’è‰²çš„å‘å‹ã€æœè£…ã€è¡¨æƒ…ã€ä½“æ€å¿…é¡»åœ¨æ‰€æœ‰é¡µé¢ä¿æŒå®Œå…¨ä¸€è‡´
2. ç»˜ç”»é£æ ¼ï¼šæ‰€æœ‰æ’å›¾å¿…é¡»ä½¿ç”¨ç›¸åŒçš„è‰ºæœ¯é£æ ¼å’Œè‰²å½©æ–¹æ¡ˆ
3. æ„å›¾æ ‡å‡†ï¼šé‡‡ç”¨å„¿ç«¥å‹å¥½çš„è§†è§’å’Œæ„å›¾æ–¹å¼
4. è´¨é‡æ ‡å‡†ï¼šæ¯ä¸ªæè¿°100-150å­—ï¼Œè¯¦ç»†å…·ä½“ï¼Œä¾¿äºAIç†è§£å’Œç”Ÿæˆ

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

å°é¢ï¼š[å°é¢æ’å›¾æè¿°ï¼ŒåŒ…å«ä¸»è¦è§’è‰²ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç¬¬1é¡µï¼š[ç¬¬1é¡µæ’å›¾æè¿°ï¼Œå¯¹åº”æ•…äº‹å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç¬¬2é¡µï¼š[ç¬¬2é¡µæ’å›¾æè¿°ï¼Œå¯¹åº”æ•…äº‹å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç¬¬3é¡µï¼š[ç¬¬3é¡µæ’å›¾æè¿°ï¼Œå¯¹åº”æ•…äº‹å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç¬¬4é¡µï¼š[ç¬¬4é¡µæ’å›¾æè¿°ï¼Œå¯¹åº”æ•…äº‹å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç¬¬5é¡µï¼š[ç¬¬5é¡µæ’å›¾æè¿°ï¼Œå¯¹åº”æ•…äº‹å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]
ç»“å°¾ï¼š[ç»“å°¾æ’å›¾æè¿°ï¼Œæ¸©é¦¨åœ†æ»¡çš„ç»“å±€ï¼Œä¸¥æ ¼éµå¾ªä¸€è‡´æ€§è¦æ±‚]

ã€é‡è¦æé†’ã€‘
æ¯ä¸ªæè¿°éƒ½å¿…é¡»æ˜ç¡®åŒ…å«è§’è‰²çš„å…³é”®ç‰¹å¾ï¼Œç¡®ä¿AIç»˜å›¾æ—¶èƒ½å¤Ÿä¿æŒè§’è‰²å½¢è±¡çš„é«˜åº¦ä¸€è‡´æ€§ã€‚`
}

// æ¨¡æ‹Ÿå“åº”å†…å®¹
function generateMockResponse() {
  return `å°é¢ï¼šæ¸©é¦¨çš„æ•…äº‹å°é¢ï¼Œå°æ˜ï¼ˆ5å²ç”·å­©ï¼Œåœ†è„¸ï¼Œé»‘è‰²çŸ­å‘ï¼Œç©¿çº¢è‰²Tæ¤å’Œè“è‰²çŸ­è£¤ï¼‰å’Œå°èŠ±ï¼ˆ4å²å¥³å­©ï¼Œé•¿å‘æ‰é©¬å°¾ï¼Œç©¿ç²‰è‰²è¿è¡£è£™ï¼‰åœ¨å…¬å›­é‡Œï¼ŒèƒŒæ™¯æœ‰ç»¿æ ‘å’Œè“å¤©ï¼Œä½“ç°å‹è°Šä¸»é¢˜
ç¬¬1é¡µï¼šå°æ˜ï¼ˆçº¢è‰²Tæ¤ï¼Œè“è‰²çŸ­è£¤ï¼Œé»‘è‰²çŸ­å‘ï¼‰å’Œå°èŠ±ï¼ˆç²‰è‰²è¿è¡£è£™ï¼Œé©¬å°¾è¾«ï¼‰åœ¨å…¬å›­è‰åœ°ä¸Šç©è€ï¼Œå‘ç°ä¸€åªæ©˜è‰²å°çŒ«èº²åœ¨èŠ±ä¸›ä¸­ï¼Œä¸¤äººè¡¨æƒ…å¥½å¥‡
ç¬¬2é¡µï¼šå°æ˜ï¼ˆä¿æŒçº¢è‰²Tæ¤è“è‰²çŸ­è£¤çš„è£…æ‰®ï¼‰è½»æŸ”åœ°æŠ±èµ·å°çŒ«ï¼Œå°èŠ±ï¼ˆç²‰è‰²è¿è¡£è£™ä¸å˜ï¼‰è¹²åœ¨æ—è¾¹é€’å‡ºå°é¥¼å¹²ï¼Œåœºæ™¯æ¸©é¦¨æœ‰çˆ±
ç¬¬3é¡µï¼šå°æ˜å’Œå°èŠ±ï¼ˆæœè£…ä¿æŒä¸€è‡´ï¼‰ç‰µæ‰‹åœ¨å…¬å›­é‡Œå¯»æ‰¾ï¼Œå°çŒ«åœ¨å°æ˜æ€€ä¸­ï¼Œè¿œå¤„æœ‰å„ç§æ¸¸ä¹è®¾æ–½ï¼Œä¸¤äººç¥æƒ…ä¸“æ³¨
ç¬¬4é¡µï¼šåœ¨å¤§æ ‘ä¸‹æ‰¾åˆ°çŒ«å¦ˆå¦ˆï¼Œå°æ˜ï¼ˆçº¢è‰²Tæ¤ï¼‰å’Œå°èŠ±ï¼ˆç²‰è‰²è£™å­ï¼‰ç«™åœ¨ä¸€æ—ï¼Œå°çŒ«å…´å¥‹åœ°è·‘å‘å¦ˆå¦ˆï¼Œåœºé¢æ¸©é¦¨æ„Ÿäºº
ç¬¬5é¡µï¼šå°æ˜ï¼ˆé»‘è‰²çŸ­å‘ï¼Œçº¢è‰²ä¸Šè¡£ï¼‰å’Œå°èŠ±ï¼ˆé©¬å°¾è¾«ï¼Œç²‰è‰²è£™è£…ï¼‰ç«™åœ¨ä¸€æ—å¾®ç¬‘è§‚çœ‹çŒ«å’ªä¸€å®¶å›¢èšï¼Œå¤•é˜³è¥¿ä¸‹çš„æ¸©é¦¨åœºæ™¯
ç»“å°¾ï¼šå°æ˜å’Œå°èŠ±ï¼ˆä¿æŒå„è‡ªç‰¹è‰²æœè£…ï¼‰æ‰‹ç‰µæ‰‹èµ°åœ¨å›å®¶çš„è·¯ä¸Šï¼ŒèƒŒæ™¯æ˜¯ç¾ä¸½çš„å¤•é˜³ï¼Œä¼ è¾¾å‹è°Šå’Œå–„è‰¯çš„ä¸»é¢˜`
}

// æ¨¡æ‹Ÿä¸€è‡´æ€§å“åº”è§£æ
function parseMockConsistentResponse(content, expectedPages, coreElements) {
  const lines = content.split('\n').filter(line => line.trim())
  
  // æå–è§’è‰²ç‰¹å¾
  const characterFeatures = ['å°æ˜ï¼š5å²ç”·å­©ï¼Œåœ†è„¸ï¼Œé»‘è‰²çŸ­å‘ï¼Œç©¿çº¢è‰²Tæ¤å’Œè“è‰²çŸ­è£¤', 'å°èŠ±ï¼š4å²å¥³å­©ï¼Œé•¿å‘æ‰é©¬å°¾ï¼Œç©¿ç²‰è‰²è¿è¡£è£™']
  
  // è§£æå„éƒ¨åˆ†
  const cover = lines.find(line => line.startsWith('å°é¢ï¼š'))?.replace('å°é¢ï¼š', '').trim() || ''
  const ending = lines.find(line => line.startsWith('ç»“å°¾ï¼š'))?.replace('ç»“å°¾ï¼š', '').trim() || ''
  
  const pages = []
  for (let i = 1; i <= expectedPages; i++) {
    const page = lines.find(line => line.startsWith(`ç¬¬${i}é¡µï¼š`))?.replace(`ç¬¬${i}é¡µï¼š`, '').trim() || ''
    pages.push(page)
  }
  
  return { cover, pages, ending, coreElements }
}

// æ¨¡æ‹Ÿä¸€è‡´æ€§æ£€æŸ¥
function checkMockConsistency(result, characters) {
  const allDescriptions = [result.cover, ...result.pages, result.ending]
  
  // æ£€æŸ¥è§’è‰²åç§°è¦†ç›–ç‡
  const characterMentions = characters.map(char => {
    const mentions = allDescriptions.filter(desc => desc.includes(char.name)).length
    return (mentions / allDescriptions.length) * 100
  })
  const characterCoverage = Math.round(characterMentions.reduce((sum, rate) => sum + rate, 0) / characters.length)
  
  // æ£€æŸ¥ç‰¹å¾æè¿°å®Œæ•´æ€§
  const featureKeywords = ['çº¢è‰²Tæ¤', 'è“è‰²çŸ­è£¤', 'ç²‰è‰²è¿è¡£è£™', 'é©¬å°¾', 'é»‘è‰²çŸ­å‘']
  const featureMentions = featureKeywords.map(keyword => {
    const mentions = allDescriptions.filter(desc => desc.includes(keyword)).length
    return mentions > 0 ? 100 : 0
  })
  const featureCompleteness = Math.round(featureMentions.reduce((sum, rate) => sum + rate, 0) / featureKeywords.length)
  
  // æ£€æŸ¥é£æ ¼ç»Ÿä¸€æ€§
  const styleKeywords = ['æ¸©é¦¨', 'å…¬å›­', 'å¤•é˜³']
  const styleMentions = styleKeywords.filter(keyword => 
    allDescriptions.some(desc => desc.includes(keyword))
  ).length
  const styleConsistency = Math.round((styleMentions / styleKeywords.length) * 100)
  
  // è®¡ç®—æ•´ä½“è¯„åˆ†
  const overallScore = Math.round((characterCoverage + featureCompleteness + styleConsistency) / 3)
  
  return {
    characterCoverage,
    featureCompleteness,
    styleConsistency,
    overallScore
  }
}

// è¿è¡Œæµ‹è¯•
testEnhancedConsistency()